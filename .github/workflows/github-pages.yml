name: Publish Wiki to GitHub Pages

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - v[0-9]+.[0-9]+.[0-9]+(-rc.+)?
  pull_request:
    paths:
      - "docs/**/*"
      - "sdk/examples/**/*"
      - "sdk/bindings/**/*"
      - "sdk/src/**/*"

jobs:
  public-wiki:
    runs-on: dell
    container:
      image: ${{ vars.DEVCONTAINER_IMAGE }}:${{ vars.DEVCONTAINER_TAG }}
      credentials:
        username: ${{ secrets.ARTIFACTORY_USERNAME }}
        password: ${{ secrets.ARTIFACTORY_PASSWORD }}

    env:
      GIT_DEPTH: 1000
      DEPLOY_ONLY: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ env.GIT_DEPTH }}

      - uses: Swatinem/rust-cache@v2

      - name: Setup Python environment
        shell: bash
        working-directory: docs
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install mkdocs-material mike mkdocs-git-revision-date-localized-plugin \
                      mkdocs-git-committers-plugin-2 mkdocs-git-authors-plugin mkdocs-typedoc
          echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV
          echo "$PWD/.venv/bin" >> $GITHUB_PATH  # Ensure mkdocs is available globally

      - name: Install project dependencies with pnpm
        shell: bash
        working-directory: docs
        run: pnpm install

      - name: Build wasm-bindings
        shell: bash
        working-directory: sdk/bindings/wasm
        run: wasm-pack build --dev --scope eto

      - name: Build Rust docs
        shell: bash
        working-directory: sdk
        run: |
          cargo doc --no-deps --all-features --lib
          mkdir -p ../docs/docs/rust-docs/doc/
          mv ../target/doc/* ../docs/docs/rust-docs/doc/

      - name: Build Java docs
        shell: bash
        working-directory: sdk/bindings/android
        run: |
          cargo build
          make build_javadoc
          mv javadoc ../../../docs/docs/

      - name: Mark repository as safe for Git
        shell: bash
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Build the documentation
        shell: bash
        working-directory: docs
        run: mkdocs build

      - name: Deploy to GitHub Pages
        if: env.DEPLOY_ONLY == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/site
          cname: docs.etospheres.com
